<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>newapi OpenAI 代理 · 模型覆写控制台</title>
  <style>
    :root {
      --bg: #0e1117;
      --panel: #161b22;
      --accent: #00c2ff;
      --accent-2: #9d6bff;
      --text: #e6edf3;
      --muted: #9ca3af;
      --border: #30363d;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(0, 194, 255, 0.12), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(157, 107, 255, 0.18), transparent 35%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px 16px;
      display: flex;
      justify-content: center;
    }
    .shell {
      width: min(1180px, 100%);
      background: rgba(22, 27, 34, 0.95);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0, 194, 255, 0.4);
      background: rgba(0, 194, 255, 0.12);
      color: var(--accent);
      font-size: 12px;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .panel {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0d1117;
      padding: 12px 12px 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    label {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    input, textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #010409;
      color: var(--text);
      font-size: 13px;
      padding: 7px 9px;
      outline: none;
    }
    input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0, 194, 255, 0.2);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.4;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b0f16;
    }
    button.secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 2fr);
      gap: 10px;
    }
    .models-list {
      max-height: 420px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .model-item {
      width: 100%;
      text-align: left;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0a0f16;
      color: var(--text);
      font-size: 13px;
      padding: 7px 9px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .model-item span.meta {
      font-size: 11px;
      color: var(--muted);
    }
    .model-item.alias {
      border-color: rgba(0, 194, 255, 0.5);
      background: rgba(0, 194, 255, 0.08);
    }
    .model-item.active {
      box-shadow: 0 0 0 1px var(--accent);
    }
    .note {
      font-size: 12px;
      color: var(--muted);
    }
    .log-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #010409;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      max-height: 120px;
      overflow: auto;
      color: #9ca3af;
    }
    .status-line {
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="title">
        <span>newapi OpenAI 代理覆写面板</span>
        <span class="pill">思考模式 · 渠道 · 重定向</span>
      </div>
      <div class="row" style="grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr) auto;">
        <label>
          代理地址
          <input id="endpoint" placeholder="默认：当前域名或 http://localhost:14300" />
        </label>
        <label>
          代理密钥（PROXY_API_KEY，可选）
          <input id="proxyKey" placeholder="用于保护代理访问" />
        </label>
        <div style="display:flex;align-items:flex-end;gap:6px;">
          <button id="refreshModelsBtn" class="secondary">刷新模型</button>
          <button id="reloadConfigBtn" class="secondary">刷新覆写</button>
        </div>
      </div>
    </header>

    <div class="layout">
      <section class="panel">
        <div class="panel-header">
          <span>模型列表（按渠道分组）</span>
          <span class="note">点击模型即可编辑渠道 / 重定向</span>
        </div>
        <div id="modelsBox" class="models-list">
          <div class="note">点击右上角“刷新模型”拉取 /v1/models</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <span>当前模型设置</span>
          <span id="currentSettingsLine" class="note">未选择模型</span>
        </div>
        <div class="row">
          <label>
            模型 ID（来自 /v1/models）
            <input id="settingsModelId" readonly />
          </label>
          <label>
            渠道标识（可选，用于区分不同上游/来源）
            <input id="settingsChannel" placeholder="例如：fox、cherry、webui 等" />
          </label>
        </div>
        <div class="row">
          <label>
            目标模型 ID（可选，实际发往上游的模型 ID）
            <input id="settingsTargetModel" placeholder="留空则使用当前模型 ID" />
          </label>
        </div>
        <div class="note">
          <strong>Thinking 覆写说明：</strong><br />
          - 当请求体中带有 <code>thinking.type = "enabled"</code> 且配置 <code>budget_tokens</code> 时，代理会自动追加 antml 思考系统提示词，长度 = <code>budget_tokens × 5</code>；<br />
          - 流式响应中 <code>&lt;thinking&gt;</code> / <code>&lt;/thinking&gt;</code> 标签将被覆写为 <code>&lt;think&gt;</code> / <code>&lt;/think&gt;</code>，便于前端解析；<br />
          - 未开启 thinking 时，请求与响应只做模型重定向和渠道标记，不做其它内容替换。
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px;">
          <button id="saveSettingsBtn">保存当前模型设置</button>
        </div>
      </section>
    </div>

    <section class="panel">
      <div class="panel-header">
        <span>覆写配置预览</span>
        <span class="note">这就是后端 /overrides 接口与环境变量 MODEL_OVERRIDE_MAP 使用的 JSON 结构</span>
      </div>
      <textarea id="configPreview" readonly style="min-height:140px;"></textarea>
      <div class="note">
        可将此 JSON 复制到服务端环境变量 <code>MODEL_OVERRIDE_MAP</code> 中，以便在无本地文件时也能恢复配置。
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <span>日志</span>
      </div>
      <div id="logBox" class="log-box"></div>
      <div id="statusLine" class="status-line"></div>
    </section>
  </div>

  <script>
    const endpointInput = document.getElementById('endpoint');
    const proxyKeyInput = document.getElementById('proxyKey');
    const refreshModelsBtn = document.getElementById('refreshModelsBtn');
    const reloadConfigBtn = document.getElementById('reloadConfigBtn');
    const modelsBox = document.getElementById('modelsBox');
    const settingsModelId = document.getElementById('settingsModelId');
    const settingsChannel = document.getElementById('settingsChannel');
    const settingsTargetModel = document.getElementById('settingsTargetModel');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const configPreview = document.getElementById('configPreview');
    const logBox = document.getElementById('logBox');
    const statusLine = document.getElementById('statusLine');
    const currentSettingsLine = document.getElementById('currentSettingsLine');

    const defaultOrigin = window.location.origin.startsWith('http')
      ? window.location.origin
      : 'http://localhost:14300';

    let modelsCache = [];
    let modelSettings = {};

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.textContent = `[${now}] ${msg}`;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }

    function setStatus(text) {
      statusLine.textContent = text || '';
      if (text) log(text);
    }

    function buildHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      const key = proxyKeyInput.value.trim() || localStorage.getItem('proxy_key') || '';
      if (key) headers['Authorization'] = `Bearer ${key}`;
      return headers;
    }

    function currentEndpoint() {
      return (endpointInput.value.trim() || localStorage.getItem('proxy_endpoint') || defaultOrigin);
    }

    function saveEndpointAndKey() {
      const ep = endpointInput.value.trim() || defaultOrigin;
      const key = proxyKeyInput.value.trim();
      localStorage.setItem('proxy_endpoint', ep);
      localStorage.setItem('proxy_key', key);
    }

    function hydrateEndpointAndKey() {
      const ep = localStorage.getItem('proxy_endpoint') || defaultOrigin;
      const key = localStorage.getItem('proxy_key') || '';
      endpointInput.value = ep;
      proxyKeyInput.value = key;
    }

    function getModelChannel(id, item) {
      const cfg = modelSettings[id] || {};
      if (cfg.channel) return cfg.channel;
      if (item && item.metadata && item.metadata.channel) return item.metadata.channel;
      return '未分组';
    }

    function renderModelList(list) {
      modelsBox.textContent = '';
      if (!list || !list.length) {
        modelsBox.textContent = '暂无模型，请确认上游配置是否正确。';
        return;
      }

      const groups = {};
      list.forEach((item) => {
        if (!item || typeof item !== 'object') return;
        const id = item.id;
        const channel = getModelChannel(id, item);
        if (!groups[channel]) groups[channel] = [];
        groups[channel].push(item);
      });

      const groupEntries = Object.entries(groups).sort((a, b) => {
        const [ca] = a;
        const [cb] = b;
        if (ca === '未分组') return 1;
        if (cb === '未分组') return -1;
        return ca.localeCompare(cb, 'zh-CN');
      });

      groupEntries.forEach(([channel, items]) => {
        const header = document.createElement('div');
        header.className = 'note';
        header.style.margin = '6px 0 2px';
        header.textContent = channel === '未分组' ? '未分组' : `渠道：${channel}`;
        modelsBox.appendChild(header);

        items.forEach((item) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'model-item';
          const isAlias = item.owned_by === 'proxy-override';
          if (isAlias) btn.classList.add('alias');
          btn.dataset.modelId = item.id;

          const main = document.createElement('span');
          main.textContent = item.id;

          const meta = document.createElement('span');
          meta.className = 'meta';
          const metaParts = [];
          if (item.alias_for) metaParts.push(`→ ${item.alias_for}`);
          meta.textContent = metaParts.join(' · ');

          btn.appendChild(main);
          btn.appendChild(meta);
          btn.onclick = () => openSettings(item.id, item);
          modelsBox.appendChild(btn);
        });
      });
    }

    async function fetchModels() {
      const endpoint = currentEndpoint();
      setStatus('正在拉取模型列表...');
      try {
        const resp = await fetch(`${endpoint}/v1/models`, { headers: buildHeaders() });
        const data = await resp.json();
        if (!resp.ok) throw new Error(JSON.stringify(data));
        modelsCache = data.data || [];
        renderModelList(modelsCache);
        setStatus('模型列表已更新，点击模型可编辑覆写设置。');
      } catch (err) {
        modelsBox.textContent = '获取失败';
        setStatus(`拉取模型失败：${err}`);
      }
    }

    function updateSettingsLine() {
      const modelId = settingsModelId.value.trim();
      if (!modelId) {
        currentSettingsLine.textContent = '未选择模型';
        return;
      }
      const cfg = modelSettings[modelId] || {};
      const channelInfo = cfg.channel ? `渠道=${cfg.channel}` : '渠道未设';
      const targetInfo = cfg.targetModel && cfg.targetModel !== modelId
        ? `重定向到=${cfg.targetModel}`
        : '未配置重定向';
      currentSettingsLine.textContent = `当前模型：${modelId} · ${channelInfo} · ${targetInfo}`;
    }

    function renderConfigPreview() {
      const cfg = {};
      Object.entries(modelSettings).forEach(([id, item]) => {
        cfg[id] = {
          channel: item.channel || undefined,
          target_model: item.targetModel || id
        };
      });
      configPreview.value = JSON.stringify(cfg, null, 2);
    }

    async function fetchOverrides() {
      const endpoint = currentEndpoint();
      try {
        const resp = await fetch(`${endpoint}/overrides`, { headers: buildHeaders() });
        const data = await resp.json();
        if (!resp.ok) throw new Error(JSON.stringify(data));
        modelSettings = {};
        Object.entries(data || {}).forEach(([mid, cfg]) => {
          modelSettings[mid] = {
            channel: cfg.channel || '',
            targetModel: cfg.target_model || mid
          };
        });
        renderConfigPreview();
        updateSettingsLine();
        setStatus('覆写配置已同步。');
      } catch (err) {
        setStatus(`获取覆写配置失败：${err}`);
      }
    }

    async function persistOverrides() {
      const endpoint = currentEndpoint();
      const payload = {};
      Object.entries(modelSettings).forEach(([mid, item]) => {
        payload[mid] = {
          channel: item.channel || undefined,
          target_model: item.targetModel || mid
        };
      });
      const resp = await fetch(`${endpoint}/overrides`, {
        method: 'POST',
        headers: buildHeaders(),
        body: JSON.stringify(payload),
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || JSON.stringify(data));
      setStatus(`覆写配置已持久化（${data.count} 条）。`);
    }

    function openSettings(modelId, modelObj) {
      settingsModelId.value = modelId;
      const cfg = modelSettings[modelId] || {};
      settingsChannel.value = cfg.channel || (modelObj && modelObj.metadata && modelObj.metadata.channel) || '';
      settingsTargetModel.value = cfg.targetModel || (modelObj && (modelObj.alias_for || modelObj.id)) || modelId;
      updateSettingsLine();

      Array.from(modelsBox.querySelectorAll('.model-item')).forEach((btn) => {
        if (btn.dataset.modelId === modelId) btn.classList.add('active');
        else btn.classList.remove('active');
      });
    }

    async function saveSettings() {
      const modelId = settingsModelId.value.trim();
      if (!modelId) {
        setStatus('请先选择一个模型。');
        return;
      }
      const channel = settingsChannel.value.trim();
      const targetModel = settingsTargetModel.value.trim();
      modelSettings[modelId] = {
        channel,
        targetModel
      };
      updateSettingsLine();
      renderConfigPreview();
      try {
        await persistOverrides();
      } catch (err) {
        setStatus(`保存覆写到服务端失败：${err}`);
        return;
      }
      setStatus(`已保存模型 ${modelId} 的覆写设置并同步到服务端。`);
    }

    refreshModelsBtn.onclick = () => {
      saveEndpointAndKey();
      fetchModels();
    };
    reloadConfigBtn.onclick = () => {
      saveEndpointAndKey();
      fetchOverrides();
    };
    saveSettingsBtn.onclick = saveSettings;

    (async function init() {
      hydrateEndpointAndKey();
      await fetchOverrides();
      await fetchModels();
    })();
  </script>
</body>
</html>

