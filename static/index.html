<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>newapi OpenAI 代理 · 模型管理</title>
    <style>
      :root {
        --bg: #0e1117;
        --panel: #161b22;
        --accent: #00c2ff;
        --text: #e6edf3;
        --muted: #9ca3af;
        --border: #30363d;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background:
          radial-gradient(circle at 10% 20%, rgba(0, 194, 255, 0.12), transparent 35%),
          radial-gradient(circle at 80% 0%, rgba(157, 107, 255, 0.18), transparent 35%),
          var(--bg);
        color: var(--text);
        min-height: 100vh;
        padding: 20px 12px;
        display: flex;
        justify-content: center;
      }
      .shell {
        width: min(1100px, 100%);
        background: rgba(22, 27, 34, 0.95);
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
      }
      label {
        font-size: 13px;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      input,
      select {
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #010409;
        color: var(--text);
        font-size: 13px;
        padding: 7px 9px;
      }
      button {
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0a0f16;
        color: var(--text);
        padding: 7px 12px;
        cursor: pointer;
      }
      button.secondary {
        background: transparent;
        color: var(--muted);
      }
      button.danger {
        border-color: #ff6b6b;
        color: #ff6b6b;
      }
      .panel {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #0d1117;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        color: var(--muted);
        font-size: 13px;
      }
      .models-list {
        max-height: 460px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .model-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .model-item {
        flex: 1;
        text-align: left;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0a0f16;
        color: var(--text);
        font-size: 13px;
        padding: 7px 9px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }
      .model-item .meta {
        font-size: 11px;
        color: var(--muted);
      }
      .note {
        color: var(--muted);
        font-size: 12px;
      }
      .log-box {
        background: #0a0f16;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px;
        height: 120px;
        overflow: auto;
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div>
          <div style="font-weight:600;">模型管理</div>
          <div class="note">仅持久化自定义模型，下游 /v1/models 只返回本列表</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="refreshModelsBtn" class="secondary">刷新上游并导入</button>
          <button id="saveCustomBtn">保存自定义模型</button>
        </div>
      </header>

      <section class="panel">
        <div class="panel-header">
          <span>代理与鉴权</span>
        </div>
        <div class="row">
          <label>
            代理地址
            <input id="endpoint" placeholder="默认当前域名或 http://localhost:14300" />
          </label>
          <label>
            代理密钥（可选）
            <input id="proxyKey" placeholder="PROXY_API_KEY" />
          </label>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <span>渠道与模型</span>
          <div style="display:flex; gap:8px; align-items:center;">
            <label style="margin:0; display:flex; align-items:center; gap:6px; color:var(--muted);">
              渠道筛选
              <select id="modelsChannelFilter">
                <option value="">全部渠道</option>
              </select>
            </label>
            <button id="addModelBtn" class="secondary" disabled>在当前渠道添加模型</button>
          </div>
        </div>
        <div id="modelsBox" class="models-list">
          <div class="note">点击左上角“刷新上游并导入”可从上游选择模型加入列表。</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <span>渠道配置（UPSTREAM_CHANNELS）</span>
          <span class="note">保存后同步到 .env</span>
        </div>
        <div id="channelList" class="note">暂无渠道</div>
        <div class="row">
          <label>
            渠道名称
            <input id="newChannelName" placeholder="如：newapi / copilot" />
          </label>
          <label>
            上游地址 base_url
            <input id="newChannelBaseUrl" placeholder="https://api.xxx.com" />
          </label>
          <label>
            上游密钥 api_key
            <input id="newChannelKey" placeholder="sk-xxxx" />
          </label>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px;">
          <button id="addChannelBtn">保存渠道</button>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <span>日志</span>
        </div>
        <div id="logBox" class="log-box"></div>
        <div id="statusLine" class="note"></div>
      </section>
    </div>

    <script>
      const endpointInput = document.getElementById("endpoint");
      const proxyKeyInput = document.getElementById("proxyKey");
      const refreshModelsBtn = document.getElementById("refreshModelsBtn");
      const saveCustomBtn = document.getElementById("saveCustomBtn");
      const modelsChannelFilter = document.getElementById("modelsChannelFilter");
      const modelsBox = document.getElementById("modelsBox");
      const addModelBtn = document.getElementById("addModelBtn");
      const channelList = document.getElementById("channelList");
      const newChannelName = document.getElementById("newChannelName");
      const newChannelBaseUrl = document.getElementById("newChannelBaseUrl");
      const newChannelKey = document.getElementById("newChannelKey");
      const addChannelBtn = document.getElementById("addChannelBtn");
      const logBox = document.getElementById("logBox");
      const statusLine = document.getElementById("statusLine");

      const defaultOrigin = window.location.origin.startsWith("http")
        ? window.location.origin
        : "http://localhost:14300";

      let customModels = {}; // {channel: [models]}
      let upstreamChannels = {};

      function log(msg) {
        const now = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.textContent = `[${now}] ${msg}`;
        logBox.appendChild(div);
        logBox.scrollTop = logBox.scrollHeight;
      }

      function setStatus(text) {
        statusLine.textContent = text || "";
        if (text) log(text);
      }

      function buildHeaders() {
        const headers = { "Content-Type": "application/json" };
        const key = proxyKeyInput.value.trim() || localStorage.getItem("proxy_key") || "";
        if (key) headers["Authorization"] = `Bearer ${key}`;
        return headers;
      }

      function currentEndpoint() {
        return endpointInput.value.trim() || localStorage.getItem("proxy_endpoint") || defaultOrigin;
      }

      function saveEndpointAndKey() {
        const ep = endpointInput.value.trim() || defaultOrigin;
        const key = proxyKeyInput.value.trim();
        localStorage.setItem("proxy_endpoint", ep);
        localStorage.setItem("proxy_key", key);
      }

      function hydrateEndpointAndKey() {
        const ep = localStorage.getItem("proxy_endpoint") || defaultOrigin;
        const key = localStorage.getItem("proxy_key") || "";
        endpointInput.value = ep;
        proxyKeyInput.value = key;
      }

      function currentChannel() {
        return modelsChannelFilter.value || "";
      }

      function renderChannelOptions() {
        modelsChannelFilter.innerHTML = "";
        const allOpt = document.createElement("option");
        allOpt.value = "";
        allOpt.textContent = "全部渠道";
        modelsChannelFilter.appendChild(allOpt);
        Object.keys(upstreamChannels || {}).forEach((name) => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          modelsChannelFilter.appendChild(opt);
        });
        // 同时补充自定义模型中已有的渠道
        Object.keys(customModels || {}).forEach((name) => {
          if (!name) return;
          if ([...modelsChannelFilter.options].some((o) => o.value === name)) return;
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          modelsChannelFilter.appendChild(opt);
        });
      }

      function renderChannels() {
        const entries = Object.entries(upstreamChannels || {});
        if (!entries.length) {
          channelList.textContent = "暂无渠道，请在下方添加。";
        } else {
          channelList.textContent = entries
            .map(([name, cfg]) => `${name} (${cfg.base_url || "未配置地址"})`)
            .join(" · ");
        }
        renderChannelOptions();
      }

      function renderModelList() {
        const list = [];
        Object.entries(customModels || {}).forEach(([ch, items]) => {
          if (!Array.isArray(items)) return;
          items.forEach((m) => {
            if (!m || typeof m !== "object") return;
            list.push({ ...m, __channel: ch });
          });
        });

        const filterCh = currentChannel();
        const groups = {};
        list.forEach((item) => {
          const ch = item.__channel || "";
          if (filterCh && ch !== filterCh) return;
          const key = ch || "未指定渠道";
          if (!groups[key]) groups[key] = [];
          groups[key].push(item);
        });

        modelsBox.textContent = "";
        if (!Object.keys(groups).length) {
          modelsBox.textContent = "暂无自定义模型。可在上方选择渠道并点击“添加模型”或刷新上游导入。";
          return;
        }

        Object.entries(groups).forEach(([ch, items]) => {
          const header = document.createElement("div");
          header.className = "note";
          header.textContent = `渠道：${ch}`;
          modelsBox.appendChild(header);

          items.forEach((item) => {
            const row = document.createElement("div");
            row.className = "model-row";

            const btn = document.createElement("div");
            btn.className = "model-item";
            const main = document.createElement("span");
            main.textContent = item.id;
            const meta = document.createElement("span");
            meta.className = "meta";
            const metaParts = [];
            if (item.alias_for) metaParts.push(`别名 → ${item.alias_for}`);
            metaParts.push(`owned_by=${item.owned_by || "local"}`);
            if (item.metadata && item.metadata.channel) metaParts.push(`channel=${item.metadata.channel}`);
            meta.textContent = metaParts.join(" · ");
            btn.appendChild(main);
            btn.appendChild(meta);
            row.appendChild(btn);

            const delBtn = document.createElement("button");
            delBtn.type = "button";
            delBtn.className = "danger";
            delBtn.textContent = "删除";
            delBtn.onclick = () => {
              removeCustomModel(item.__channel || "", item.id);
            };
            row.appendChild(delBtn);

            modelsBox.appendChild(row);
          });
        });
      }

      function removeCustomModel(channel, modelId) {
        if (!customModels[channel]) return;
        customModels[channel] = customModels[channel].filter((m) => m && m.id !== modelId);
        if (customModels[channel].length === 0) delete customModels[channel];
        renderModelList();
        setStatus(`已删除模型 ${modelId}（渠道=${channel || "未指定"}），记得点击“保存自定义模型”。`);
      }

      function addCustomModel(channel, modelId, owned_by = "local", alias_for = "") {
        if (!customModels[channel]) customModels[channel] = [];
        // 去重
        customModels[channel] = customModels[channel].filter((m) => m && m.id !== modelId);
        const meta = channel ? { channel } : undefined;
        const obj = { id: modelId, object: "model", owned_by: owned_by || "local" };
        if (alias_for) obj.alias_for = alias_for;
        if (meta) obj.metadata = meta;
        customModels[channel].push(obj);
        renderModelList();
      }

      async function fetchCustomModels() {
        const endpoint = currentEndpoint();
        try {
          const resp = await fetch(`${endpoint}/custom-models`, { headers: buildHeaders() });
          const data = await resp.json();
          if (!resp.ok) throw new Error(JSON.stringify(data));
          customModels = data || {};
          renderChannelOptions();
          renderModelList();
          setStatus("已加载自定义模型列表。");
        } catch (err) {
          setStatus(`获取自定义模型失败：${err}`);
        }
      }

      async function saveCustomModels() {
        const endpoint = currentEndpoint();
        try {
          const resp = await fetch(`${endpoint}/custom-models`, {
            method: "POST",
            headers: buildHeaders(),
            body: JSON.stringify(customModels || {}),
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.detail || JSON.stringify(data));
          setStatus(`自定义模型已保存，共 ${data.count || 0} 条。`);
        } catch (err) {
          setStatus(`保存自定义模型失败：${err}`);
        }
      }

      async function fetchChannels() {
        const endpoint = currentEndpoint();
        try {
          const resp = await fetch(`${endpoint}/channels`, { headers: buildHeaders() });
          const data = await resp.json();
          if (!resp.ok) throw new Error(JSON.stringify(data));
          upstreamChannels = data.channels || {};
          renderChannels();
        } catch (err) {
          setStatus(`获取渠道失败：${err}`);
        }
      }

      async function saveChannelsToServer(channelsObj) {
        const endpoint = currentEndpoint();
        const resp = await fetch(`${endpoint}/channels`, {
          method: "POST",
          headers: buildHeaders(),
          body: JSON.stringify({ channels: channelsObj }),
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.detail || JSON.stringify(data));
        upstreamChannels = channelsObj;
        renderChannels();
      }

      async function fetchUpstreamModels() {
        const endpoint = currentEndpoint();
        const ch = currentChannel();
        let url = `${endpoint}/v1/upstream-models`;
        if (ch) url += `?channel=${encodeURIComponent(ch)}`;
        setStatus("正在拉取上游模型...");
        const resp = await fetch(url, { headers: buildHeaders() });
        const data = await resp.json();
        if (!resp.ok) throw new Error(JSON.stringify(data));
        return data.data || [];
      }

      function promptSelectModels(upstreamList) {
        if (!upstreamList || !upstreamList.length) {
          alert("上游无模型或拉取失败。");
          return [];
        }
        const names = upstreamList.map((m) => m.id).join(", ");
        const input = prompt(
          `上游模型共 ${upstreamList.length} 个。\n当前渠道：${currentChannel() || "未指定"}。\n输入要导入的模型 ID（逗号分隔），留空取消：\n${names}`
        );
        if (!input) return [];
        const ids = input
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        const picked = upstreamList.filter((m) => ids.includes(m.id));
        return picked;
      }

      refreshModelsBtn.onclick = async () => {
        saveEndpointAndKey();
        try {
          const upstreamList = await fetchUpstreamModels();
          const picked = promptSelectModels(upstreamList);
          const ch = currentChannel() || "";
          if (!picked.length) {
            setStatus("未选择任何模型导入。");
            return;
          }
          picked.forEach((m) => {
            addCustomModel(ch, m.id, m.owned_by || "local", m.alias_for || "");
          });
          setStatus(`已导入 ${picked.length} 个模型到渠道 ${ch || "未指定"}，记得保存。`);
        } catch (err) {
          setStatus(`刷新上游失败：${err}`);
        }
      };

      addModelBtn.onclick = () => {
        const ch = currentChannel() || "";
        const id = prompt(`输入要添加的模型 ID（渠道：${ch || "未指定"}）`);
        if (!id) return;
        addCustomModel(ch, id.trim());
        setStatus(`已添加本地模型 ${id}（渠道=${ch || "未指定"}），记得保存。`);
      };

      saveCustomBtn.onclick = () => {
        saveEndpointAndKey();
        saveCustomModels();
      };

      modelsChannelFilter.onchange = () => {
        renderModelList();
        addModelBtn.disabled = currentChannel() === "";
      };

      addChannelBtn.onclick = async () => {
        const name = newChannelName.value.trim();
        const baseUrl = newChannelBaseUrl.value.trim();
        const apiKey = newChannelKey.value.trim();
        if (!name || !baseUrl || !apiKey) {
          setStatus("请完整填写渠道名称、地址和密钥。");
          return;
        }
        const next = { ...(upstreamChannels || {}) };
        next[name] = { base_url: baseUrl, api_key: apiKey };
        try {
          await saveChannelsToServer(next);
        } catch (err) {
          setStatus(`保存渠道失败：${err}`);
          return;
        }
        newChannelName.value = "";
        newChannelBaseUrl.value = "";
        newChannelKey.value = "";
        setStatus(`渠道 ${name} 已更新并同步到 .env（UPSTREAM_CHANNELS）。`);
      };

      (async function init() {
        hydrateEndpointAndKey();
        addModelBtn.disabled = true;
        await fetchChannels();
        await fetchCustomModels();
      })();
    </script>
  </body>
</html>
