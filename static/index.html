<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewAPI 代理管理</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --success: #10b981;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        .subtitle { font-size: 0.875rem; color: var(--text-muted); margin-top: 4px; }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            gap: 6px;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: white; border-color: var(--border); color: var(--text-main); }
        .btn-secondary:hover { background-color: #f1f5f9; }
        .btn-danger { background-color: white; border-color: var(--border); color: var(--danger); }
        .btn-danger:hover { background-color: #fef2f2; border-color: var(--danger); }
        .btn-sm { padding: 4px 10px; font-size: 0.75rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Inputs */
        input, select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background-color: white;
            font-size: 0.875rem;
            color: var(--text-main);
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
        }
        .card-title { font-weight: 600; font-size: 1rem; color: #0f172a; }
        .card-body { padding: 16px; display: flex; flex-direction: column; gap: 16px; }

        /* Grid Layout */
        .grid-main {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            align-items: start;
        }
        @media (max-width: 768px) {
            .grid-main { grid-template-columns: 1fr; }
        }

        /* Lists */
        .list-group { display: flex; flex-direction: column; gap: 8px; }
        .list-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.1s;
        }
        .list-item:hover { border-color: #cbd5e1; }
        .item-content { display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 0; }
        .item-title { font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 0.75rem; color: var(--text-muted); display: flex; gap: 8px; align-items: center; }
        
        /* Badges */
        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: #e2e8f0;
            color: #475569;
        }
        .badge-blue { background-color: #dbeafe; color: #1e40af; }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-purple { background-color: #f3e8ff; color: #6b21a8; }

        /* Modal */
        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center; z-index: 50;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: white; width: 90%; max-width: 800px; max-height: 85vh;
            border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; border-radius: 0 0 12px 12px; }

        /* Toast */
        .toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: white; padding: 12px 16px; border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            border-left: 4px solid var(--primary);
            font-size: 0.875rem; animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Utility */
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .flex-col { display: flex; flex-direction: column; gap: 10px; }
        .text-sm { font-size: 0.875rem; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>NewAPI 代理管理</h1>
            <div class="subtitle">管理上游渠道、模型映射与别名</div>
        </div>
        <div class="flex-row">
            <button id="refreshBtn" class="btn btn-secondary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                刷新数据
            </button>
            <button id="saveAllBtn" class="btn btn-primary">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                保存所有更改
            </button>
        </div>
    </header>

    <!-- Settings Bar -->
    <div class="card">
        <div class="card-body" style="padding: 12px 16px; flex-direction: row; align-items: center; gap: 16px; background: #fff;">
            <div class="flex-row" style="flex: 1;">
                <span class="text-sm" style="white-space: nowrap; color: var(--text-muted);">代理地址:</span>
                <input id="endpoint" placeholder="http://localhost:14300" style="max-width: 250px;">
                <span class="text-sm" style="white-space: nowrap; color: var(--text-muted);">密钥:</span>
                <input id="proxyKey" type="password" placeholder="PROXY_API_KEY (可选)" style="max-width: 200px;">
            </div>
            <div class="text-sm" style="color: var(--success);" id="connectionStatus"></div>
        </div>
    </div>

    <div class="grid-main">
        <!-- Left Column: Channels -->
        <div class="flex-col">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">上游渠道</span>
                    <span class="badge badge-blue" id="channelCount">0</span>
                </div>
                <div class="card-body">
                    <div id="channelList" class="list-group">
                        <!-- Channels rendered here -->
                        <div class="text-sm text-muted" style="text-align: center; padding: 20px;">暂无渠道</div>
                    </div>
                    
                    <div style="border-top: 1px solid var(--border); padding-top: 16px;">
                        <div class="text-sm" style="font-weight: 600; margin-bottom: 8px;">添加新渠道</div>
                        <div class="flex-col">
                            <input id="newChannelName" placeholder="渠道名称 (如: openai)">
                            <input id="newChannelBaseUrl" placeholder="Base URL (如: https://api.openai.com)">
                            <input id="newChannelKey" placeholder="API Key (sk-...)">
                            <button id="addChannelBtn" class="btn btn-secondary w-full">添加渠道</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Models -->
        <div class="flex-col">
            <div class="card">
                <div class="card-header">
                    <div class="flex-row">
                        <span class="card-title">模型列表</span>
                        <select id="channelFilter" style="width: auto; padding: 4px 8px; font-size: 0.8rem;">
                            <option value="">全部渠道</option>
                        </select>
                    </div>
                    <div class="flex-row">
                        <button id="importBtn" class="btn btn-sm btn-secondary">从上游导入</button>
                        <button id="addModelBtn" class="btn btn-sm btn-secondary">手动添加</button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="modelList" class="list-group" style="max-height: 600px; overflow-y: auto; padding: 16px;">
                        <!-- Models rendered here -->
                        <div class="text-sm text-muted" style="text-align: center; padding: 40px;">
                            暂无模型，请从上游导入或手动添加
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="modal-mask">
    <div class="modal">
        <div class="card-header">
            <span class="card-title">从上游导入模型</span>
            <button class="btn btn-sm btn-secondary" onclick="closeModal('importModal')">✕</button>
        </div>
        <div class="modal-body">
            <div class="flex-row" style="margin-bottom: 16px;">
                <span class="text-sm">目标渠道:</span>
                <select id="importTargetChannel" style="max-width: 200px;"></select>
                <button id="fetchUpstreamBtn" class="btn btn-sm btn-primary">拉取列表</button>
            </div>
            <div id="importList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                <div class="text-sm text-muted">请选择渠道并点击拉取列表...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="selectAllImport">全选</button>
            <button class="btn btn-secondary" id="clearImport">清空</button>
            <button class="btn btn-primary" id="confirmImport">确认导入</button>
        </div>
    </div>
</div>

<!-- Edit Model Modal -->
<div id="editModelModal" class="modal-mask">
    <div class="modal" style="max-width: 500px;">
        <div class="card-header">
            <span class="card-title" id="editModelTitle">编辑模型</span>
            <button class="btn btn-sm btn-secondary" onclick="closeModal('editModelModal')">✕</button>
        </div>
        <div class="modal-body flex-col">
            <label class="text-sm">
                模型 ID（上游真实模型 ID）
                <input id="editModelId" placeholder="例如: claude-haiku-4.5-fox">
            </label>
            <label class="text-sm">
                别名目标（可选，填写客户端请求时使用的模型名）
                <input id="editModelTarget" placeholder="例如: claude-haiku-4.5-20251001">
                <div class="text-sm text-muted" style="font-size: 0.75rem; margin-top: 4px;">
                    若填写此项，则“别名目标”将作为客户端可见的模型名称，并映射到上方的模型 ID（上游真实模型）。
                </div>
            </label>
            <label class="text-sm">
                所属渠道
                <select id="editModelChannel"></select>
            </label>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="deleteModelBtn" style="margin-right: auto;">删除模型</button>
            <button class="btn btn-primary" id="saveModelBtn">保存更改</button>
        </div>
    </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
    // State
    let state = {
        channels: {},
        models: {}, // { channelName: [modelObjects] }
        upstreamModels: []
    };

    // DOM Elements
    const els = {
        endpoint: document.getElementById('endpoint'),
        proxyKey: document.getElementById('proxyKey'),
        channelList: document.getElementById('channelList'),
        modelList: document.getElementById('modelList'),
        channelFilter: document.getElementById('channelFilter'),
        importTargetChannel: document.getElementById('importTargetChannel'),
        importList: document.getElementById('importList'),
        channelCount: document.getElementById('channelCount'),
        // Edit Modal
        editModelId: document.getElementById('editModelId'),
        editModelTarget: document.getElementById('editModelTarget'),
        editModelChannel: document.getElementById('editModelChannel'),
        deleteModelBtn: document.getElementById('deleteModelBtn'),
        saveModelBtn: document.getElementById('saveModelBtn')
    };

    // Utils
    const toast = (msg, type = 'info') => {
        const div = document.createElement('div');
        div.className = 'toast';
        div.textContent = msg;
        div.style.borderLeftColor = type === 'error' ? 'var(--danger)' : (type === 'success' ? 'var(--success)' : 'var(--primary)');
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(() => {
            div.style.opacity = '0';
            div.style.transform = 'translateX(100%)';
            setTimeout(() => div.remove(), 300);
        }, 3000);
    };

    const getHeaders = () => {
        const headers = { 'Content-Type': 'application/json' };
        const key = els.proxyKey.value.trim();
        if (key) headers['Authorization'] = `Bearer ${key}`;
        return headers;
    };

    const getBaseUrl = () => {
        let url = els.endpoint.value.trim();
        if (!url) url = window.location.origin;
        return url.replace(/\/$/, '');
    };

    // API Interactions
    async function fetchChannels() {
        try {
            const res = await fetch(`${getBaseUrl()}/channels`, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to fetch channels');
            const data = await res.json();
            state.channels = data.channels || {};
            renderChannels();
            updateChannelSelects();
        } catch (e) {
            toast('获取渠道失败: ' + e.message, 'error');
        }
    }

    async function fetchModels() {
        try {
            const res = await fetch(`${getBaseUrl()}/custom-models`, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to fetch models');
            state.models = await res.json() || {};
            renderModels();
        } catch (e) {
            toast('获取模型失败: ' + e.message, 'error');
        }
    }

    async function saveChannels() {
        try {
            const res = await fetch(`${getBaseUrl()}/channels`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ channels: state.channels })
            });
            if (!res.ok) throw new Error('Failed to save channels');
            toast('渠道配置已保存', 'success');
        } catch (e) {
            toast('保存渠道失败: ' + e.message, 'error');
        }
    }

    async function saveModels() {
        try {
            const res = await fetch(`${getBaseUrl()}/custom-models`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(state.models)
            });
            if (!res.ok) throw new Error('Failed to save models');
            toast('模型配置已保存', 'success');
        } catch (e) {
            toast('保存模型失败: ' + e.message, 'error');
        }
    }

    // Rendering
    function renderChannels() {
        els.channelList.innerHTML = '';
        const names = Object.keys(state.channels);
        els.channelCount.textContent = names.length;
        
        if (names.length === 0) {
            els.channelList.innerHTML = '<div class="text-sm text-muted" style="text-align: center; padding: 20px;">暂无渠道</div>';
            return;
        }

        names.forEach(name => {
            const ch = state.channels[name];
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="item-content">
                    <div class="item-title">${name}</div>
                    <div class="item-meta" title="${ch.base_url}">${ch.base_url || 'No URL'}</div>
                </div>
                <button class="btn btn-sm btn-danger" onclick="deleteChannel('${name}')">删除</button>
            `;
            els.channelList.appendChild(div);
        });
    }

    function updateChannelSelects() {
        const options = Object.keys(state.channels).map(c => `<option value="${c}">${c}</option>`).join('');
        const allOptions = `<option value="">全部渠道</option>` + options;
        
        // Preserve selection if possible
        const currentFilter = els.channelFilter.value;
        els.channelFilter.innerHTML = allOptions;
        els.channelFilter.value = currentFilter;

        els.importTargetChannel.innerHTML = options;
        els.editModelChannel.innerHTML = options;
    }

    function renderModels() {
        els.modelList.innerHTML = '';
        const filter = els.channelFilter.value;
        let hasModels = false;

        Object.entries(state.models).forEach(([channel, models]) => {
            if (filter && channel !== filter) return;
            if (!Array.isArray(models) || models.length === 0) return;

            // Channel Header
            if (!filter) {
                const header = document.createElement('div');
                header.style.padding = '8px 0 4px 0';
                header.style.fontWeight = '600';
                header.style.fontSize = '0.85rem';
                header.style.color = 'var(--text-muted)';
                header.textContent = `渠道: ${channel}`;
                els.modelList.appendChild(header);
            }

            models.forEach(m => {
                hasModels = true;
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.cursor = 'pointer';
                div.onclick = () => openEditModelModal(channel, m);
                
                let badges = `<span class="badge badge-blue">${channel}</span>`;
                let meta = `ID: ${m.id}`;
                
                if (m.alias_for) {
                    badges += ` <span class="badge badge-purple">别名</span>`;
                    meta += ` → 指向: ${m.alias_for}`;
                } else {
                    badges += ` <span class="badge badge-green">模型</span>`;
                }

                div.innerHTML = `
                    <div class="item-content">
                        <div class="flex-row" style="gap: 6px;">
                            <span class="item-title">${m.id}</span>
                            ${badges}
                        </div>
                        <div class="item-meta">${meta}</div>
                    </div>
                    <div style="color: var(--text-muted);">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                `;
                els.modelList.appendChild(div);
            });
        });

        if (!hasModels) {
            els.modelList.innerHTML = '<div class="text-sm text-muted" style="text-align: center; padding: 40px;">暂无模型</div>';
        }
    }

    // Actions
    window.deleteChannel = (name) => {
        if (!confirm(`确定删除渠道 ${name} 吗?`)) return;
        delete state.channels[name];
        renderChannels();
        updateChannelSelects();
        toast('渠道已删除 (记得保存)', 'info');
    };

    window.closeModal = (id) => {
        document.getElementById(id).style.display = 'none';
    };

    // Event Listeners
    document.getElementById('addChannelBtn').onclick = () => {
        const name = document.getElementById('newChannelName').value.trim();
        const url = document.getElementById('newChannelBaseUrl').value.trim();
        const key = document.getElementById('newChannelKey').value.trim();

        if (!name || !url || !key) return toast('请填写完整渠道信息', 'error');
        
        state.channels[name] = { base_url: url, api_key: key };
        renderChannels();
        updateChannelSelects();
        
        document.getElementById('newChannelName').value = '';
        document.getElementById('newChannelBaseUrl').value = '';
        document.getElementById('newChannelKey').value = '';
        toast('渠道已添加 (记得保存)', 'success');
    };

    document.getElementById('refreshBtn').onclick = async () => {
        await fetchChannels();
        await fetchModels();
        toast('数据已刷新', 'success');
    };

    document.getElementById('saveAllBtn').onclick = async () => {
        await saveChannels();
        await saveModels();
    };

    els.channelFilter.onchange = renderModels;

    // Import Logic
    document.getElementById('importBtn').onclick = () => {
        document.getElementById('importModal').style.display = 'flex';
        updateChannelSelects();
        // Auto select current filter if set
        if (els.channelFilter.value) {
            els.importTargetChannel.value = els.channelFilter.value;
        }
        // Clear list on open
        els.importList.innerHTML = '<div class="text-sm text-muted">请选择渠道并点击拉取列表...</div>';
    };

    els.importTargetChannel.onchange = () => {
        els.importList.innerHTML = '<div class="text-sm text-muted">请点击拉取列表...</div>';
    };

    document.getElementById('fetchUpstreamBtn').onclick = async () => {
        const channel = els.importTargetChannel.value;
        if (!channel) return toast('请先选择目标渠道', 'error');
        
        try {
            const res = await fetch(`${getBaseUrl()}/v1/upstream-models?channel=${encodeURIComponent(channel)}`, { headers: getHeaders() });
            if (!res.ok) throw new Error('Failed to fetch upstream models');
            const data = await res.json();
            state.upstreamModels = data.data || [];
            
            els.importList.innerHTML = '';
            if (state.upstreamModels.length === 0) {
                els.importList.innerHTML = '<div class="text-sm text-muted">该渠道未返回任何模型</div>';
                return;
            }

            state.upstreamModels.forEach((m, idx) => {
                const div = document.createElement('label');
                div.className = 'list-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <input type="checkbox" value="${idx}" style="width: auto; margin-right: 10px;">
                    <div class="item-content">
                        <div class="item-title">${m.id}</div>
                        <div class="item-meta">${m.owned_by}</div>
                    </div>
                `;
                els.importList.appendChild(div);
            });
        } catch (e) {
            toast('拉取失败: ' + e.message, 'error');
        }
    };

    document.getElementById('selectAllImport').onclick = () => {
        document.querySelectorAll('#importList input[type=checkbox]').forEach(cb => cb.checked = true);
    };
    document.getElementById('clearImport').onclick = () => {
        document.querySelectorAll('#importList input[type=checkbox]').forEach(cb => cb.checked = false);
    };

    document.getElementById('confirmImport').onclick = () => {
        const channel = els.importTargetChannel.value;
        if (!channel) return;
        
        const selectedIdxs = Array.from(document.querySelectorAll('#importList input[type=checkbox]:checked')).map(cb => cb.value);
        if (selectedIdxs.length === 0) return toast('未选择任何模型', 'error');

        if (!state.models[channel]) state.models[channel] = [];
        
        let count = 0;
        selectedIdxs.forEach(idx => {
            const m = state.upstreamModels[idx];
            // Check duplicate
            if (!state.models[channel].find(ex => ex.id === m.id)) {
                state.models[channel].push({
                    id: m.id,
                    object: 'model',
                    owned_by: m.owned_by || 'upstream',
                    metadata: { channel }
                });
                count++;
            }
        });

        renderModels();
        closeModal('importModal');
        toast(`已导入 ${count} 个模型 (记得保存)`, 'success');
    };

    // Edit / Add Model Logic
    let currentEditModel = null; // { channel, id } or null for add

    function openEditModelModal(channel, model) {
        currentEditModel = { channel, id: model.id };
        document.getElementById('editModelTitle').textContent = '编辑模型';
        els.editModelId.value = model.id;
        els.editModelId.disabled = true; // ID cannot be changed
        els.editModelTarget.value = model.alias_for || '';
        els.editModelChannel.value = channel;
        els.deleteModelBtn.style.display = 'inline-flex';
        document.getElementById('editModelModal').style.display = 'flex';
    }

    document.getElementById('addModelBtn').onclick = () => {
        currentEditModel = null;
        document.getElementById('editModelTitle').textContent = '添加模型';
        els.editModelId.value = '';
        els.editModelId.disabled = false;
        els.editModelTarget.value = '';
        els.editModelChannel.value = els.channelFilter.value || '';
        els.deleteModelBtn.style.display = 'none';
        document.getElementById('editModelModal').style.display = 'flex';
    };

    els.saveModelBtn.onclick = () => {
        const id = els.editModelId.value.trim();
        const target = els.editModelTarget.value.trim();
        const newChannel = els.editModelChannel.value;

        if (!id || !newChannel) return toast('请填写模型 ID 和渠道', 'error');

        // If editing, remove old entry first (channel might have changed)
        if (currentEditModel) {
            const oldCh = currentEditModel.channel;
            const oldId = currentEditModel.id;
            if (state.models[oldCh]) {
                state.models[oldCh] = state.models[oldCh].filter(m => m.id !== oldId);
                if (state.models[oldCh].length === 0) delete state.models[oldCh];
            }
        } else {
            // Adding new: check if ID exists in target channel
            if (state.models[newChannel] && state.models[newChannel].find(m => m.id === id)) {
                if (!confirm(`模型 ${id} 在渠道 ${newChannel} 中已存在，是否覆盖?`)) return;
                state.models[newChannel] = state.models[newChannel].filter(m => m.id !== id);
            }
        }

        if (!state.models[newChannel]) state.models[newChannel] = [];
        
        const newModel = {
            id: id,
            object: 'model',
            owned_by: target ? 'proxy-override' : 'custom',
            metadata: { channel: newChannel }
        };
        if (target) newModel.alias_for = target;

        state.models[newChannel].push(newModel);
        
        renderModels();
        closeModal('editModelModal');
        toast('模型已保存 (记得点击右上角保存所有更改)', 'success');
    };

    els.deleteModelBtn.onclick = () => {
        if (!currentEditModel) return;
        const { channel, id } = currentEditModel;
        if (!confirm(`确定删除模型 ${id} 吗?`)) return;
        
        if (state.models[channel]) {
            state.models[channel] = state.models[channel].filter(m => m.id !== id);
            if (state.models[channel].length === 0) delete state.models[channel];
        }
        renderModels();
        closeModal('editModelModal');
        toast('模型已删除 (记得保存)', 'info');
    };

    // Init
    (async function init() {
        // Load local storage
        const savedEp = localStorage.getItem('proxy_endpoint');
        const savedKey = localStorage.getItem('proxy_key');
        if (savedEp) els.endpoint.value = savedEp;
        if (savedKey) els.proxyKey.value = savedKey;

        // Auto save settings on change
        els.endpoint.onchange = () => localStorage.setItem('proxy_endpoint', els.endpoint.value.trim());
        els.proxyKey.onchange = () => localStorage.setItem('proxy_key', els.proxyKey.value.trim());

        await fetchChannels();
        await fetchModels();
    })();

</script>
</body>
</html>
